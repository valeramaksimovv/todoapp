{% extends "base.html" %}

{% block content %}
<div class="page-head">
    <div>
        <h1 class="page-title">Board</h1>
        <p class="page-subtitle">Manage tasks across statuses.</p>
    </div>
    <div class="page-actions">
        <a class="btn btn-primary" href="{% url 'card_create' %}">Create new card</a>
    </div>
</div>

<div class="actions-bar">
    <div class="actions-left">
        <form method="get">
            <label style="display:flex; gap:10px; align-items:center; margin:0;">
                <input type="checkbox" name="mine" value="1" {% if mine %}checked{% endif %}
                    onchange="this.form.submit()">
                Show only my cards
            </label>
        </form>
    </div>
</div>

<div class="board">
    {% for col in columns %}
    <div class="column" data-status="{{ col.code }}">
        <h3>{{ col.label }}</h3>

        <div class="cards" data-dropzone="{{ col.code }}">
            {% for card in col.cards %}
            <div class="card" draggable="true" data-card-id="{{ card.id }}">
                <a class="card-title" href="{% url 'card_detail' card.id %}">
                    #{{ card.id }} {{ card.name }}
                </a>

                <div class="card-meta">
                    <span class="badge badge-priority p-{{ card.priority|lower }}">
                        {{ card.get_priority_display }}
                    </span>

                    <span class="assignee">
                        {% if card.assignee %}
                        @{{ card.assignee.username }}
                        {% else %}
                        Unassigned
                        {% endif %}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie("csrftoken");

    let draggedCardId = null;
    let draggedEl = null;

    document.querySelectorAll(".card[draggable='true']").forEach(el => {
        el.addEventListener("dragstart", (e) => {
            draggedCardId = el.dataset.cardId;
            draggedEl = el;
            e.dataTransfer.effectAllowed = "move";
        });
    });

    document.querySelectorAll("[data-dropzone]").forEach(zone => {
        zone.addEventListener("dragover", (e) => {
            e.preventDefault();
            zone.classList.add("is-over");
            e.dataTransfer.dropEffect = "move";
        });

        zone.addEventListener("dragleave", () => {
            zone.classList.remove("is-over");
        });

        zone.addEventListener("drop", async (e) => {
            e.preventDefault();
            zone.classList.remove("is-over");

            const newStatus = zone.dataset.dropzone;
            if (draggedEl) zone.appendChild(draggedEl);

            const url = `/card/${draggedCardId}/move/`;
            const body = new URLSearchParams({ status: newStatus });

            const resp = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrftoken,
                },
                body: body.toString(),
            });

            if (!resp.ok) alert("Failed to move card. Refresh page.");
        });
    });
</script>
{% endblock %}