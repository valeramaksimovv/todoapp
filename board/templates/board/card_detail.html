{% extends "base.html" %}

{% block content %}
<div class="actions-bar">
    <div class="actions-left">
        <a class="btn btn-secondary" href="{% url 'board' %}">← Back to board</a>
    </div>
    <div class="actions-right">
        <a class="btn btn-secondary" href="{% url 'card_edit' card.pk %}">Edit</a>
    </div>
</div>

<div class="page-head">
    <div>
        <h1 class="page-title">#{{ card.id }} {{ card.name }}</h1>
        <p class="page-subtitle">Card details, attachments and comments.</p>
    </div>
</div>

<div class="panel">
    <div class="kv">
        <div class="k">Status</div>
        <div class="v">{{ card.get_status_display }}</div>

        <div class="k">Priority</div>
        <div class="v">{{ card.get_priority_display }}</div>

        <div class="k">Assignee</div>
        <div class="v">{{ card.assignee|default:"—" }}</div>

        <div class="k">Reporter</div>
        <div class="v">{{ card.reporter }}</div>

        <div class="k">Created</div>
        <div class="v">{{ card.created_at }}</div>

        <div class="k">Updated</div>
        <div class="v">{{ card.updated_at }}</div>
    </div>

    <hr>

    <h2>Description</h2>
    {% if card.description %}
    <p style="white-space: pre-wrap; color: var(--text); margin-top: 6px;">{{ card.description }}</p>
    {% else %}
    <p>No description.</p>
    {% endif %}
</div>

<div style="height: 14px;"></div>

<div class="panel">
    <div class="page-head" style="margin-bottom: 10px;">
        <div>
            <h2 style="margin-bottom: 0;">Attachments</h2>
            <p class="page-subtitle" style="margin-top: 6px;">Files uploaded to this card.</p>
        </div>
    </div>

    {% if attachments %}
    <table class="table">
        <thead>
            <tr>
                <th>File</th>
                <th>Uploaded by</th>
                <th>Uploaded at</th>
            </tr>
        </thead>
        <tbody>
            {% for a in attachments %}
            <tr>
                <td>
                    <a href="{{ a.file.url }}" target="_blank">{{ a.file.name }}</a>
                </td>
                <td>{{ a.uploaded_by }}</td>
                <td>{{ a.uploaded_at }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No attachments yet.</p>
    {% endif %}

    <hr>

    <h3 style="margin-bottom: 8px;">Upload file</h3>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="field-row">
            {{ attachment_form.as_p }}
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" type="submit" name="add_attachment">Upload</button>
        </div>
    </form>
</div>

<div style="height: 14px;"></div>

<div class="panel">
    <div class="page-head" style="margin-bottom: 10px;">
        <div>
            <h2 style="margin-bottom: 0;">Comments</h2>
            <p class="page-subtitle" style="margin-top: 6px;">Discussion history for this card.</p>
        </div>
    </div>

    {% if comments %}
    <div style="display:flex; flex-direction:column; gap: 12px;">
        {% for c in comments %}
        <div class="panel panel--compact" style="background: var(--surface-2);">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:baseline;">
                <div style="font-weight:700; color: var(--text);">{{ c.created_by }}</div>
                <div style="font-size:12px; color: var(--muted-2);">{{ c.created_at }}</div>
            </div>
            <div style="margin-top: 8px; color: var(--text); white-space: pre-wrap;">{{ c.text }}</div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>No comments yet.</p>
    {% endif %}

    <hr>

    <h3 style="margin-bottom: 8px;">Add comment</h3>
    <form method="post">
        {% csrf_token %}
        <div class="field-row">
            {{ comment_form.as_p }}
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" type="submit" name="add_comment">Add</button>
        </div>
    </form>
</div>
{% endblock %}